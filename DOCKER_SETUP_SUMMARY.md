# Docker Setup Summary for Lorekeeper

## üì¶ Created Files

### Core Docker Files
1. **docker-compose.yml** - Main Docker Compose configuration for local development
2. **docker-compose.prod.yml** - Production-ready Docker Compose configuration
3. **Dockerfile** - Development Docker image for PHP application
4. **Dockerfile.prod** - Production-optimized Docker image
5. **.dockerignore** - Excludes unnecessary files from Docker build

### Configuration Files
6. **.env.docker** - Docker-optimized environment variable template
7. **docker/nginx/nginx.conf** - Nginx web server configuration
8. **docker/php/php-prod.ini** - Production PHP configuration with opcache

### Scripts
9. **docker-setup.sh** - Automated setup script for first-time installation
10. **docker/scripts/backup.sh** - Automated database backup script
11. **Makefile** - Convenient command shortcuts for Docker operations

### Documentation
12. **DOCKER.md** - Comprehensive Docker setup guide and troubleshooting

## üèóÔ∏è Architecture Overview

The Docker setup includes these services:

### Development (docker-compose.yml)
- **app**: PHP 8.1-FPM application server
- **webserver**: Nginx web server (port 80)
- **db**: MySQL 8.0 database (port 3306)
- **redis**: Redis 7 cache/queue (port 6379)
- **queue**: Laravel queue worker
- **scheduler**: Laravel task scheduler
- **mailhog**: Email testing tool (ports 1025, 8025)
- **node**: (optional) Asset compilation

### Production (docker-compose.prod.yml)
- All development services plus:
- Enhanced security configurations
- Multiple queue worker replicas
- Automated backup service
- Optimized PHP with opcache
- SSL/TLS support (requires configuration)
- Resource limits and logging

## üöÄ Quick Start Guide

### Option 1: Automated Setup (Recommended)

```bash
# Make script executable (already done)
chmod +x docker-setup.sh

# Run setup
./docker-setup.sh

# Create admin user
docker-compose exec app php artisan setup-admin-user
```

### Option 2: Using Makefile

```bash
# View all available commands
make help

# Run initial setup
make setup

# Create admin user
make admin

# View logs
make logs
```

### Option 3: Manual Setup

```bash
# Copy environment file
cp .env.docker .env

# Edit .env with your settings
nano .env

# Build containers
docker-compose build

# Start services
docker-compose up -d

# Run migrations
docker-compose exec app php artisan migrate

# Add initial data
docker-compose exec app php artisan add-site-settings
docker-compose exec app php artisan add-text-pages
docker-compose exec app php artisan copy-default-images

# Create admin
docker-compose exec app php artisan setup-admin-user
```

## üîß Configuration Requirements

### Required Environment Variables

You MUST configure these before running:

1. **DeviantArt OAuth** (Required for login)
   ```env
   DEVIANTART_KEY=your_client_id
   DEVIANTART_SECRET=your_client_secret
   DEVIANTART_REDIRECT_URI=http://localhost/auth/callback/deviantart
   ```

2. **Application Key** (Auto-generated by setup script)
   ```env
   APP_KEY=base64:...
   ```

3. **Contact Information**
   ```env
   CONTACT_ADDRESS=admin@yourdomain.com
   DEVIANTART_ACCOUNT=your_group_account
   ```

### Optional Social Media OAuth

Configure these if you want additional login options:
- Twitter
- Tumblr
- Twitch
- Instagram

See `.env.docker` for all available options.

## üìä Service Access Points

After running `docker-compose up -d`:

| Service | URL | Purpose |
|---------|-----|---------|
| Web Application | http://localhost | Main Lorekeeper site |
| MailHog UI | http://localhost:8025 | View test emails |
| Database | localhost:3306 | MySQL (use credentials from .env) |
| Redis | localhost:6379 | Cache/Queue (password in .env) |

## üéØ Common Tasks

### Development Workflow

```bash
# Start development
make up

# Watch logs
make logs

# Run migrations
make migrate

# Clear caches
make cache-clear

# Access shell
make shell

# Stop everything
make down
```

### Asset Compilation

```bash
# Install npm packages
make npm-install

# Watch for changes
make npm-watch

# Build for production
make npm-prod
```

### Database Management

```bash
# Backup database
make backup-db

# Restore database
make restore-db file=backup.sql

# Access MySQL shell
make db-shell
```

## üîê Security Considerations

### For Development
- Default passwords are weak (they're visible in .env.docker)
- Debug mode is enabled
- All ports are exposed
- MailHog is used instead of real SMTP

### For Production
- Change ALL passwords before deployment
- Set `APP_DEBUG=false`
- Use real mail service
- Configure SSL certificates
- Limit port exposure
- Enable firewall rules
- Regular backups
- Monitor logs

## üìù Environment File Comparison

| Variable | Development | Production |
|----------|-------------|------------|
| APP_ENV | local | production |
| APP_DEBUG | true | false |
| DB_HOST | db | db |
| REDIS_HOST | redis | redis |
| MAIL_HOST | mailhog | smtp.yourprovider.com |
| QUEUE_CONNECTION | redis | redis |
| CACHE_DRIVER | redis | redis |

## üêõ Troubleshooting

### Port Already in Use
```bash
# Change port in .env
WEB_PORT=8080

# Restart
docker-compose down && docker-compose up -d
```

### Permission Errors
```bash
make permissions
```

### Database Connection Failed
```bash
# Check if database is ready
docker-compose exec db mysqladmin ping -h localhost -u root -p

# Check credentials in .env
```

### Clear Everything and Start Fresh
```bash
make clean  # WARNING: Deletes all data!
make setup
```

## üìö Additional Resources

- **Full Documentation**: See DOCKER.md
- **Laravel Docs**: https://laravel.com/docs/8.x
- **Lorekeeper Wiki**: http://wiki.lorekeeper.me
- **Docker Docs**: https://docs.docker.com

## ‚úÖ Validation Checklist

Before considering your setup complete:

- [ ] Docker and Docker Compose installed
- [ ] .env file created and configured
- [ ] APP_KEY generated
- [ ] DeviantArt OAuth credentials added
- [ ] Services started successfully
- [ ] Database migrated
- [ ] Initial data seeded
- [ ] Admin user created
- [ ] Can access http://localhost
- [ ] Can login with DeviantArt
- [ ] MailHog receiving test emails

## üéâ What's Next?

After successful setup:

1. **Customize Your Site**
   - Edit site settings in admin panel
   - Upload your logo and images
   - Configure your ARPG rules

2. **Set Up Content**
   - Add traits
   - Add item categories
   - Add currency types
   - Create characters

3. **Configure Social Media**
   - Add additional OAuth providers if needed
   - Test authentication flows

4. **Development**
   - Compile assets with `make npm-dev`
   - Watch logs with `make logs`
   - Run tests

## üìû Support

If you encounter issues:
1. Check DOCKER.md for detailed troubleshooting
2. Review logs: `make logs`
3. Check Lorekeeper Discord: https://discord.gg/U4JZfsu
4. Check Laravel documentation
5. Check Docker documentation

---

**Version**: 1.0  
**Created**: 2025-11-25  
**For**: Lorekeeper Laravel Application  
**Tested With**: Docker 20.10+, Docker Compose 2.0+
